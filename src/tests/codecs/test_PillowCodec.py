from io import BytesIO

from PIL.Image import Image
from AEPi import CompressionFormat
from AEPi.codecs.PillowCodec import PillowCodec
from PIL import Image

from AEPi.constants import CompressionFormat

SMILEY_PNG_PATH = "src/tests/assets/smiley.png"

# This is the simely image compressed to DXT using AEIEditor.
COMPRESSED_DXT5 = b"\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\xFF\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\xFF\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\xFF\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\x3F\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x01\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x10\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x40\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x07\x00\x00\x00\x00\xFD\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x55\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x04\x01\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xD4\x39\x54\x14\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x05\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x09\x3B\x00\x00\x40\x55\x00\x00\x03\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\xFF\x38\x38\xB0\xFF\x38\x38\x94\xFF\x38\x38\xB0\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x38\x38\xB0\xFF\x38\x38\x94\xFF\x38\x38\xB0\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x38\x38\xB0\xFF\x38\x38\xB0\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x3B\x6C\x4D\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x3B\x6C\x4D\xFF\x3B\x6C\x4D\xFF\x34\x53\x3F\xFF\x34\x53\x3F\xFF"
COMPRESSED_DXT3 = b"\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\xFF\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\xFF\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\xFF\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x87\xB9\x55\x3F\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x01\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x10\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x40\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xDF\xFF\x07\x00\x00\x00\x00\xFD\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x55\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x04\x01\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xD4\x39\x54\x14\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\x09\x3B\x00\x00\x40\x55"
COMPRESSED_DXT1 = b"\xDF\xFF\x87\xB9\x55\xFF\x00\x00\xDF\xFF\x87\xB9\x55\xFF\x00\x00\xDF\xFF\x87\xB9\x55\xFF\x00\x00\xDF\xFF\x87\xB9\x55\x3F\x00\x00\x00\x00\xFF\xFF\x55\x55\x55\x55\x00\x00\xFF\xFF\x55\x55\x54\x55\x00\x00\xFF\xFF\x55\x55\x45\x55\x00\x00\xFF\xFF\x55\x55\x55\x55\x00\x00\xFF\xFF\x55\x55\x15\x55\xDF\xFF\x07\x00\x00\x00\x00\xFD\x00\x00\xFF\xFF\x55\x55\x55\x00\x00\x00\xFF\xFF\x55\x55\x51\x54\x00\x00\xFF\xFF\x55\x55\x55\x55\xD4\x39\xFF\xFF\x01\x41\x55\x55\x00\x00\xFF\xFF\x55\x55\x55\x55\x09\x3B\xFF\xFF\x55\x55\x15\x00"


CODEC = PillowCodec()

def smileyImage():
    png = Image.open(SMILEY_PNG_PATH)

    if png.mode != "RGBA":
        return png.convert("RGBA")
    
    return png


def test_decompress_DXT5_succeeds():
    with smileyImage() as expected, BytesIO(COMPRESSED_DXT5) as compressed:
        actual = CODEC.decompress(compressed, CompressionFormat.DXT5)
        for coords in zip(range(expected.width), range(expected.height)):
            assert expected.getpixel(coords) == actual.getpixel(coords) # type: ignore[reportUnknownMemberType]


def test_decompress_DXT3_succeeds():
    with smileyImage() as expected, BytesIO(COMPRESSED_DXT3) as compressed:
        actual = CODEC.decompress(compressed, CompressionFormat.DXT3)
        for coords in zip(range(expected.width), range(expected.height)):
            assert expected.getpixel(coords) == actual.getpixel(coords) # type: ignore[reportUnknownMemberType]


def test_decompress_DXT1_succeeds():
    with smileyImage() as expected, BytesIO(COMPRESSED_DXT1) as compressed:
        actual = CODEC.decompress(compressed, CompressionFormat.DXT1)
        for coords in zip(range(expected.width), range(expected.height)):
            assert expected.getpixel(coords) == actual.getpixel(coords) # type: ignore[reportUnknownMemberType]